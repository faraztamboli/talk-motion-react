function JS2PyClient(e,n){this.serverName=void 0===e?"ws://localhost:8082":e,this.clientPageId=void 0===n?"Undefined":n,this.isOpen=!1,this.jsFunctionDict=[],this.pythonCallbackDict=[],this.binaryFunctionQueue=[],this.PythonFunctions={},this.socket=null,this.PythonFunctionsHelp={},this.pythonMultipleCallbackDict={},this.PythonFunctionsArgs={},this.JS2Py={};let t=null;this.PreOpenEventHandlers=[],this.PreCloseEventHandlers=[],this.PreMessageEventHandlers=[],this.PostOpenEventHandlers=[],this.PostCloseEventHandlers=[],this.PostMessageEventHandlers=[],this.addPreOpenEventHandler=e=>this.PreOpenEventHandlers.push(e),this.addPreCloseEventHandler=e=>this.PreCloseEventHandlers.push(e),this.addPreMessageEventHandler=e=>this.PreMessageEventHandlers.push(e),this.addPostOpenEventHandler=e=>this.PostOpenEventHandlers.push(e),this.addPostCloseEventHandler=e=>this.PostCloseEventHandlers.push(e),this.addPostMessageEventHandler=e=>this.PostMessageEventHandlers.push(e),this.getServerString=function(){return this.serverName+"/"+this.clientPageId},this.readCallbackArguments=function(e,...n){for(var t=n.length-1;t>=0&&"function"==typeof n[t];--t);return[e,n.slice(0,t+1),n.slice(t+1)]},this.registerMultipleCallbackPythonFunction=function(e,...n){this.pythonMultipleCallbackDict[e]=n},this.callMultipleCallbackPythonFunction=function(e,...n){var t=this.readCallbackArguments(e,...n);e=t[0];let i=t[1][0],s=t[2];this.isOpen?(this.socket.send(JSON.stringify({funcName:e,args:i,session_id:this.getSessionId()})),console.log("Function : "+e+" called with arguments: "+JSON.stringify(i))):console.log("Connection not open."),s.length>0&&this.registerMultipleCallbackPythonFunction(e,...s)},this.registerCallbackToPythonFunction=function(e,n){var t=this.pythonCallbackDict.map((function(e){return e.funcName})).indexOf(e);t<0?this.pythonCallbackDict.push({funcName:e,callback:n}):this.pythonCallbackDict[t].callback=n},this.getSessionId=function(){return sessionStorage.getItem("JS2PY_SESSION_ID")},this.registerJSFunctionToBeCalledByPython=function(e,n){this.jsFunctionDict.push({funcName:e,func:n})},this.callFunc=function(e,n,t){this.isOpen?(this.socket.send(JSON.stringify({funcName:e,args:n,session_id:this.getSessionId()})),console.log("Function : "+e+" called with arguments: "+JSON.stringify(n))):console.log("Connection not open."),void 0===t||this.registerCallbackToPythonFunction(e,t)},this.callPythonFunction=function(e,n,...t){this.callMultipleCallbackPythonFunction(e,n,...t)},this.callPythonFunctionBinary=function(e,n,t,i){void 0===n&&(n={}),n.isBinary=!0,this.callFunc(e,n),this.isOpen?(this.sendBinary(t),void 0===i||this.registerCallbackToPythonFunction(e,i)):console.log("Connection not open.")},this.sendBinary=function(e){var n=new FileReader;n.onload=function(e){var n=e.target.result;this.socket&&1==this.socket.readyState&&this.socket.send(n)},n.readAsArrayBuffer(e)},this.sendNonImageBinary=function(e){if(e.type.match(/image.*/))console.log("The dropped file is an image: ",e.type);else{var n=new FileReader;n.onload=function(e){var n=e.target.result;this.socket&&1==this.socket.readyState&&this.socket.send(n)},n.readAsArrayBuffer(e)}},this.sendImageBinary=function(e){if(e.type.match(/image.*/)){var n=new FileReader;n.onload=function(e){var n=e.target.result;this.socket&&1==this.socket.readyState&&this.socket.send(n)},n.readAsArrayBuffer(e)}else console.log("The dropped file is not an image: ",e.type)},this.createJSProxyFunctions=function(e){for(var n in this.PythonFunctionsArgs){var i=this.PythonFunctionsArgs[n];i.push("...func");var s="var paramNames = this.PythonFunctionsArgs['"+n+"'].slice(0, -1);\nvar args = Array.prototype.slice.call(arguments); var inputObject = {}; for(var i in paramNames) { var paramName = paramNames[i]; if(paramName != '...func') { inputObject[paramName] = args[i];} } return this.callMultipleCallbackPythonFunction('"+n+"', inputObject, ...func);";if(i.push(s),t=this,n.indexOf(".")>=0){for(var r=n.split("."),a=this.PythonFunctions,o=0;o<r.length-1;o++)r[o]in a||(a[r[o]]={}),a=a[r[o]];a[r[r.length-1]]=Function.apply(null,i).bind(this)}else this.PythonFunctions[n]=Function.apply(null,i).bind(this)}},this.start=function(){void 0!==this.oninit&&this.oninit();var e=this.getServerString();console.log("Connecting to : "+e+" ..."),this.socket=new WebSocket(e),this.socket.binaryType="arraybuffer",t=this,this.socket.onopen=function(){console.log("Connected to Server :"+e),t.PreOpenEventHandlers.forEach((e=>e())),t.isOpen=!0,void 0!==t.onopen&&(t.callMultipleCallbackPythonFunction("getPythonFunctionLibrary",{},(function(e){for(var n in t.PythonFunctionsArgs={},e)e[n].shift(),"session_id"==e[n][0]&&e[n].shift(),t.PythonFunctionsArgs[n]=e[n];t.createJSProxyFunctions(""),t.onopen()})),t.callMultipleCallbackPythonFunction("getPythonFunctionLibraryHelp",{},(function(e){t.PythonFunctionsHelp=e}))),t.PostOpenEventHandlers.forEach((e=>e()))},this.socket.onmessage=function(e){if(t.PreMessageEventHandlers.forEach((e=>e())),void 0!==t.onmessagereceived&&t.onmessagereceived(e),"string"==typeof e.data){console.log("Message received: "+e.data);var n=JSON.parse(e.data);if("args"in n){if(!((r=t.jsFunctionDict.map((function(e){return e.funcName})).indexOf(n.funcName))>=0)){if("getPythonFunctionLibrary"===n.funcName)return;throw"No function defined for "+n.funcName}var i=t.jsFunctionDict[r];"isBinary"in n.args?t.binaryFunctionQueue.push({funcName:n.funcName,callback:i.func,args:n.args}):i.func(n.args)}else if("streaming"in n){if(!(n.funcName in t.pythonMultipleCallbackDict))throw"No function callback defined for "+n.funcName;switch((s=t.pythonMultipleCallbackDict[n.funcName]).length){case 0:break;case 1:"error"in n&&s[0](n.error,!1),"return"in n&&s[0](n.streaming,n.return,!1);break;case 2:"error"in n&&s[0](n.error,!1),"return"in n&&s[0](n.streaming,n.return,!1),"row"==n.streaming&&s[1](n.stream_index,n.stream_item,!1);break;case 3:"error"in n&&s[0](n.error,!1),"start"==n.streaming&&s[0](n.return,!1),"row"==n.streaming&&s[1](n.stream_index,n.stream_item,!1),"end"==n.streaming&&s[2](n.stream_empty,!1);break;case 4:"error"in n&&s[4](n.error,!1),"start"==n.streaming&&s[0](n.return,!1),"row"==n.streaming&&s[1](n.stream_index,n.stream_item,!1),"end"==n.streaming&&s[2](n.stream_empty,!1);break;default:throw"Too many callbacks for "+n.funcName}}else if(n.funcName in t.pythonMultipleCallbackDict){var s;switch((s=t.pythonMultipleCallbackDict[n.funcName]).length){case 0:break;case 1:"error"in n&&s[0](n.error,!1),"return"in n&&s[0](n.return,!1);break;case 2:"error"in n&&s[1](n.error,!1),"return"in n&&s[0](n.return,!1);break;case 3:"error"in n&&s[0](n.error,!1),"return"in n&&s[0](n.return,!1);break;default:throw"Too many callbacks for "+n.funcName}}else{var r;if(!((r=t.pythonCallbackDict.map((function(e){return e.funcName})).indexOf(n.funcName))>=0))throw"No function defined for "+n.funcName;i=t.pythonCallbackDict[r];void 0===n.return?void 0!==n.error&&i.callback(n.error,!1):i.callback(n.return,!0)}}else{for(var a=new Uint8Array(e.data),o=" ",c=0;c<a.length;c++)o+=("00 "+a[c].toString(16)).substr(-2);var l=e.data,u=new Uint8Array(l),h=new Blob([u.buffer]);if(t.binaryFunctionQueue.length>0){var d=t.binaryFunctionQueue.shift();d.args.blob=h,d.callback(d.args)}else{var f=new FileReader;f.onload=function(e){imgFig.src=e.target.result},f.readAsDataURL(h),document.getElementById("StatusBar").innerHTML="Chart Loading Completed ..."}console.log("message(b) received : "+o)}void 0!==t.onmessageprocessed&&t.onmessageprocessed(),t.PostMessageEventHandlers.forEach((e=>e()))},this.socket.onclose=function(n){console.log("Connection to "+e+" closed."),t.PreCloseEventHandlers.forEach((e=>e())),t.isOpen=!1,socket=null,void 0!==t.onclose&&t.onclose(),t.PostCloseEventHandlers.forEach((e=>e()))}},this.getRemotePyClient=function(){return this.PythonFunctions}}export{JS2PyClient as RemotePy};